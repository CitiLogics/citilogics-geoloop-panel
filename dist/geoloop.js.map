{"version":3,"sources":["../src/geoloop.js"],"names":["moment","mapboxgl","d3","GeoLoop","ctrl","mapContainer","createMap","frames","currentFrameIndex","animation","pause","select","panel","id","on","stopAnimation","startAnimation","stepFrame","length","targetFrame","parseInt","property","console","log","mapCenterLonLat","parseFloat","mapCenterLongitude","mapCenterLatitude","accessToken","mbApiKey","map","Map","container","style","mapStyle","center","zoom","initialZoom","interactive","userInteractionEnabled","geoResult","addSource","e","legend","data","needToRedrawFrames","clearFrames","createFrames","errors","forEach","item","removeLayer","error","dataCharacteristics","timeValues","geo","isSourceLoaded","createFramesSafely","attemptsLeft","interval","setInterval","clearInterval","sizeIsDynamic","sizeRamp","codeTo","colorIsDynamic","colorRamp","featureType","renderType","layerType","opts","layerTypes","sizeStops","colorStops","minInput","maxInput","auto","min","max","minValue","maxValue","nStops","iStop","stop","push","colorInterpolator","time","frameName","pp","geoFilter","duration","type","stops","fixedValue","addLayer","source","paint","filter","attr","selectAll","html","inputRange","Math","round","join","theRamp","framesPerSecond","oldFrame","newFrame","opacitySelectors","selector","setPaintProperty","tstamp","timeStr","unix","format","hideTime","text","resize","panTo","mapCenterMoved","zoomFactor","setZoom","remove"],"mappings":"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","file":"geoloop.js","sourcesContent":["/* eslint-disable id-length, no-unused-vars */\nimport moment from 'moment';\nimport mapboxgl from './libs/mapbox-gl';\nimport * as d3 from './libs/d3';\n/* eslint-disable id-length, no-unused-vars */\n\nexport default class GeoLoop {\n  constructor(ctrl, mapContainer) {\n    this.ctrl = ctrl;\n    this.mapContainer = mapContainer;\n    this.createMap();\n    this.frames = []; // list of timestamps\n    this.currentFrameIndex = 0;\n    this.animation = {};\n    this.pause = false;\n    // register overlay button click event\n    d3.select('#map_' + this.ctrl.panel.id + '_button_pause').on('click', () => {\n      // toggle pause\n      this.pause = !this.pause;\n      if (this.pause) {\n        this.stopAnimation();\n      } else {\n        this.startAnimation();\n      }\n    });\n    d3.select('#map_' + this.ctrl.panel.id + '_button_backward').on('click', () => {\n      // go one frame backward\n      this.pause = true;\n      this.stopAnimation();\n      this.stepFrame(((this.currentFrameIndex + this.frames.length) - 1) % this.frames.length);\n    });\n    d3.select('#map_' + this.ctrl.panel.id + '_button_forward').on('click', () => {\n      // go one frame forward\n      this.pause = true;\n      this.stopAnimation();\n      this.stepFrame((this.currentFrameIndex + 1) % this.frames.length);\n    });\n    // register overlay slider input event\n    d3.select('#map_' + this.ctrl.panel.id + '_slider').on('input', () => {\n      // pause\n      this.pause = true;\n      this.stopAnimation();\n      // set frame to selected date/time\n      const targetFrame = parseInt(d3.select('#map_' + this.ctrl.panel.id + '_slider').property('value'), 10);\n      this.stepFrame(targetFrame);\n    });\n  }\n\n  createMap() {\n    console.log('creating mapbox-map');\n    const mapCenterLonLat = [parseFloat(this.ctrl.panel.mapCenterLongitude), parseFloat(this.ctrl.panel.mapCenterLatitude)];\n    mapboxgl.accessToken = this.ctrl.panel.mbApiKey;\n    this.map = new mapboxgl.Map({\n      container: this.mapContainer,\n      style: 'mapbox://styles/mapbox/' + this.ctrl.panel.mapStyle,\n      center: mapCenterLonLat,\n      zoom: parseFloat(this.ctrl.panel.initialZoom),\n      interactive: this.ctrl.panel.userInteractionEnabled\n    });\n    // load geo data if there already is some (created by ctrl.updateGeoDataFeatures)\n    this.map.on('load', () => {\n      if (this.ctrl.geoResult) {\n        console.log('loading cached geo data into mapbox-map');\n        try {\n          this.map.addSource('geo', this.ctrl.geoResult);\n        } catch (e) {\n          // don't panic on error, just print it\n          console.log('add source error: ', e);\n        }\n      }\n    });\n  }\n\n  createLegend() {\n    this.legend = {};\n  }\n\n  needToRedrawFrames() {\n    this.legend = {};\n    return true;\n  }\n\n  drawLayerFrames() {\n    console.log('drawing layer frames');\n    const data = this.ctrl.data;\n    if (this.needToRedrawFrames(data)) {\n      this.stopAnimation();\n      this.clearFrames();\n      this.createFrames(data);\n      this.startAnimation();\n    }\n  }\n\n  clearFrames() {\n    let errors = 0;\n    this.frames.forEach((item) => {\n      try {\n        this.map.removeLayer('f-' + item);\n      } catch (e) {\n        // don't stop on error\n        errors += 1;\n      }\n    });\n    if (errors) {\n      console.error('failed to remove' + errors + 'layers from mapbox-map');\n    }\n    this.frames = [];\n  }\n\n  createFrames() {\n    if (!this.ctrl.dataCharacteristics.timeValues) {\n      console.log('no series to display (while trying to create frames)');\n      return;\n    }\n\n    if (!this.ctrl.geo) {\n      console.log('no geo data (while trying to create frames)');\n      return;\n    }\n\n    if (!this.map) {\n      console.log('no map found (while trying to create frames)');\n      return;\n    }\n\n    if (this.map.isSourceLoaded('geo')) {\n      console.log('geo source found on first try. Starting to build frames.');\n      this.createFramesSafely();\n    } else {\n      // console.log('no geo source in map. maybe not loaded?');\n      // this is stupid to use setInterval.\n      // but mapbox doesn't seem to have a on-source-loaded event that reliably works\n      // for this purpose.\n      let attemptsLeft = 15;  // slow connections might need a lot of time\n      const interval = setInterval(() => {\n        if (!this.map) {\n          console.log('map was unloaded while waiting for geo source');\n          clearInterval(interval);\n        } else if (this.map.isSourceLoaded('geo')) {\n          console.log('geo source found. Starting to build frames');\n          clearInterval(interval);\n          this.createFramesSafely();\n        } else {\n          console.log('no geo source found. Trying again...');\n          attemptsLeft -= 1;\n          if (attemptsLeft <= 0) {\n            clearInterval(interval);\n            console.error('Failed to load geo source. Try to refresh manually?');\n          }\n        }\n      }, 1000);\n    }\n  }\n\n  createFramesSafely() {\n    const sizeIsDynamic = (this.ctrl.panel.sizeRamp.codeTo === 'measurement');\n    const colorIsDynamic = (this.ctrl.panel.colorRamp.codeTo === 'measurement');\n    const featureType = this.ctrl.panel.renderType;\n    const layerType = this.ctrl.opts.layerTypes[featureType];\n    let sizeStops = [[0, 1], [100, 10]];\n    const colorStops = [];\n\n    if (sizeIsDynamic) {\n      // populate the sizeStops array with the input/output values\n      let minInput = 0;\n      let maxInput = 1;\n      if (this.ctrl.panel.sizeRamp.auto) {\n        minInput = this.ctrl.dataCharacteristics.min;\n        maxInput = this.ctrl.dataCharacteristics.max;\n      } else {\n        minInput = parseFloat(this.ctrl.panel.sizeRamp.minValue);\n        maxInput = parseFloat(this.ctrl.panel.sizeRamp.maxValue);\n      }\n\n      sizeStops = [[minInput, parseFloat(this.ctrl.panel.sizeRamp.min)], [maxInput, parseFloat(this.ctrl.panel.sizeRamp.max)]];\n      // console.log('size stops: ', sizeStops);\n    }\n\n    if (colorIsDynamic) {\n      // populate the sizeStops array with the input/output values\n      let minInput = 0;\n      let maxInput = 1;\n      if (this.ctrl.panel.colorRamp.auto) {\n        minInput = this.ctrl.dataCharacteristics.min;\n        maxInput = this.ctrl.dataCharacteristics.max;\n      } else {\n        minInput = parseFloat(this.ctrl.panel.colorRamp.minValue);\n        maxInput = parseFloat(this.ctrl.panel.colorRamp.maxValue);\n      }\n\n      const nStops = 25;\n\n      for (let iStop = 0; iStop <= nStops; iStop += 1) {\n        const stop = minInput + ((iStop / nStops) * (maxInput - minInput));\n        colorStops.push([stop, this.ctrl.panel.colorInterpolator(stop)]);\n      }\n\n      // console.log('color stops: ', colorStops);\n    }\n\n    this.ctrl.dataCharacteristics.timeValues.forEach((time) => {\n      const frameName = 'f-' + time;\n      // create new map layer for this animation frame (name is the time code)\n      const pp = {}; // paint properties\n      let geoFilter = [];\n      if (featureType === 'line') {\n        geoFilter = ['==', '$type', 'LineString'];\n        pp['line-opacity'] = 0;\n        pp['line-opacity-transition'] = { duration: 0 };\n        pp['line-width'] = sizeIsDynamic ? {\n          property: frameName,\n          type: 'exponential',\n          stops: sizeStops\n        } : parseFloat(this.ctrl.panel.sizeRamp.fixedValue);\n        pp['line-color'] = colorIsDynamic ? {\n          property: frameName,\n          type: 'exponential',\n          stops: colorStops\n        } : parseFloat(this.ctrl.panel.colorRamp.fixedValue);\n      } else if (featureType === 'point') {\n        geoFilter = ['==', '$type', 'Point'];\n        pp['circle-opacity'] = 0;\n        pp['circle-opacity-transition'] = { duration: 0 };\n        pp['circle-radius'] = sizeIsDynamic ? {\n          property: frameName,\n          type: 'exponential',\n          stops: sizeStops\n        } : parseFloat(this.ctrl.panel.sizeRamp.fixedValue);\n        pp['circle-color'] = colorIsDynamic ? {\n          property: frameName,\n          type: 'exponential',\n          stops: colorStops\n        } : this.ctrl.panel.colorRamp.fixedValue;\n      } else if (featureType === 'polygon') {\n        geoFilter = ['==', '$type', 'Polygon'];\n        pp['fill-opacity'] = 0;\n        pp['fill-opacity-transition'] = { duration: 0 };\n        pp['fill-color'] = colorIsDynamic ? {\n          property: frameName,\n          type: 'exponential',\n          stops: colorStops\n        } : this.ctrl.panel.colorRamp.fixedValue;\n      }\n\n      this.map.addLayer({\n        id: 'f-' + time,\n        type: layerType,\n        source: 'geo',\n        paint: pp,\n        filter: geoFilter,\n      });\n\n      this.frames.push(time);\n    });\n\n    // get slider component, set min/max/value\n    d3.select('#map_' + this.ctrl.panel.id + '_slider')\n      .attr('min', 0)\n      .attr('max', this.frames.length);\n    // update colorbar legend and text\n    d3.select('#map_' + this.ctrl.panel.id + '_legend').selectAll('.legend_text').html(this.ctrl.inputRange.map(Math.round).join(' - '));\n    d3.select('#map_' + this.ctrl.panel.id + '_legend').selectAll('.bar').style('background', 'linear-gradient(to right, ' + [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1].map(this.ctrl.theRamp).join(', ') + ')');\n  }\n\n\n  startAnimation() {\n    if (this.animation) {\n      this.stopAnimation();\n    }\n\n    // start the animation with the specified fps\n    this.animation = setInterval(() => {\n      this.stepFrame();\n    }, 1000 / this.ctrl.panel.framesPerSecond);\n  }\n\n  stopAnimation() {\n    clearInterval(this.animation);\n    this.animation = null;\n  }\n\n  stepFrame(targetFrame = -1) {\n    if (!this.map) {\n      return;\n    }\n    if (this.frames.length === 0) {\n      // console.log('skipping animation: no frames');\n      return;\n    }\n    const oldFrame = 'f-' + this.frames[this.currentFrameIndex];\n    this.currentFrameIndex = targetFrame >= 0 ? targetFrame : this.currentFrameIndex + 1;\n    this.currentFrameIndex %= this.frames.length;\n    const newFrame = 'f-' + this.frames[this.currentFrameIndex];\n\n    const opacitySelectors = {\n      'point': 'circle-opacity',\n      'polygon': 'fill-opacity',\n      'line': 'line-opacity'\n    };\n    const selector = opacitySelectors[this.ctrl.panel.renderType];\n\n    this.map.setPaintProperty(newFrame, selector, 1);\n    this.map.setPaintProperty(oldFrame, selector, 0);\n    const tstamp = this.frames[this.currentFrameIndex] / 1e3;\n    const timeStr = moment.unix(tstamp).format(this.ctrl.panel.hideTime ? 'YYYY-MM-DD' : 'YYYY-MM-DD HH:mm:ss');\n\n    // set time string in legend\n    d3.select('#map_' + this.ctrl.panel.id + '_date').text(timeStr);\n    // set slider position to indicate time-location\n    d3.select('#map_' + this.ctrl.panel.id + '_slider').property('value', this.currentFrameIndex);\n  }\n\n  resize() {\n    this.map.resize();\n  }\n\n  panToMapCenter() {\n    this.map.panTo([parseFloat(this.ctrl.panel.mapCenterLongitude), parseFloat(this.ctrl.panel.mapCenterLatitude)]);\n    this.ctrl.mapCenterMoved = false;\n  }\n\n  setZoom(zoomFactor) {\n    this.map.setZoom(parseInt(zoomFactor, 10));\n  }\n\n  remove() {\n    this.stopAnimation();\n    this.clearFrames();\n    if (this.map) {\n      this.map.remove();\n    }\n    this.map = null;\n  }\n}\n"]}